const chromium = require('@sparticuz/chromium');
const puppeteer = require('puppeteer-core');

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');

  const { targetUrls } = JSON.parse(req.body);
  const results = [];

  const browser = await puppeteer.launch({
    args: chromium.args,
    executablePath: await chromium.executablePath(),
    headless: chromium.headless,
  });

  const page = await browser.newPage();

  for (let url of targetUrls) {
    try {
      await page.goto(url, { waitUntil: 'networkidle2' });
      
      // Selettore universale per i tasti "Mostra numero" (adattato per i principali portali)
      const selectors = ['.contact-button', '.show-number', 'button[data-testid="show-phone"]'];
      for (let s of selectors) {
        const btn = await page.$(s);
        if (btn) {
          await btn.click();
          await new Promise(r => setTimeout(r, 1500)); // Attesa decriptazione
        }
      }

      const phoneNumber = await page.evaluate(() => {
        const el = document.querySelector('.phone-number, .contact-phone, b');
        return el ? el.innerText : 'Non trovato o Captcha attivo';
      });

      results.push({ url, phone: phoneNumber });
    } catch (e) {
      results.push({ url, phone: "Errore di timeout" });
    }
  }

  await browser.close();
  res.status(200).json({ numbers: results });
}
